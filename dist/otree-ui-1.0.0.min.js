const t=new RegExp(/^[a-zA-Z]\w+(\.\w+)*$/);function e(e){if(!e||!t.exec(e))throw new Error(`Invalid ref: ${e}`)}function i(t,e){return t==e||e.startsWith(t+".")}function s(t,e){if(t==e)return"";if(e.startsWith(t+"."))return e.slice(t.length+1);throw new Error(`Incompatible refs: ${t} / ${e}`)}function n(t,e){return e.split(".").reduce(((t,e)=>t&&e in t?t[e]:void 0),t)}function a(t,e,i){const s=e.split("."),n=s.slice(0,-1),a=s[s.length-1];let r=n.reduce(((t,e)=>e in t?t[e]:function(t,e){return t[e]={}}(t,e)),t);if(void 0===r)throw new Error(`Incompatible ref ${e}`);void 0===i?delete r[a]:r[a]=i}var r=Object.freeze({__proto__:null,validate:e,includes:i,strip:s,extract:n,update:a});class o extends Map{constructor(t,i){let s=[...Object.entries(t)];i&&(s=s.map((([t,e])=>[i+"."+t,e]))),super(s),this.forEach(((t,i)=>e(i)))}affects(t){return[...this.keys()].some((e=>i(e,t)))}pick(t){let e=[...this.keys()].filter((e=>i(e,t)));if(0==e.length)return;if(1!=e.length)throw new Error(`Incompatible changeset for ${t}`);e=e[0];let a=this.get(e);return e==t?a:n(a,s(e,t))}patch(t){this.forEach(((e,i)=>{a(t,i,e)}))}}var h=Object.freeze({__proto__:null,Ref:r,Changes:o});function l(t,e){t.style.display=e?null:"none"}function c(t,e){t.disabled=e,t.classList.toggle("ot-disabled",e)}function p(t){return t.classList.contains("ot-disabled")}function d(t,e){t.innerText=null==e?"":e}function u(t,e){t.classList.remove(...t.classList),t.classList.add(...e)}function m(t,e,i){null==i?t.removeAttribute(e):t.setAttribute(e,i)}function g(t,e){null==e?t.replaceChildren():t.replaceChildren(e)}function f(t){return"INPUT"==t.tagName&&"text"==t.type||"TEXTAREA"==t.tagName}var v=Object.freeze({__proto__:null,loadImage:function(t){const e=new Image;return new Promise(((i,s)=>{e.onload=()=>i(e),e.onerror=s,e.src=t}))},toggleDisplay:l,toggleDisabled:c,isDisabled:p,setText:d,setClasses:u,setAttr:m,setChild:g,isTextInput:f});var w=Object.freeze({__proto__:null,choice:function(t){return t[Math.floor(Math.random()*t.length)]}});async function E(t){return new Promise(((e,i)=>{setTimeout((()=>e()),t)}))}function y(t,e=0){return window.setTimeout(t,e)}function b(t){window.clearTimeout(t)}class k{constructor(){this.timers=new Map}delay(t,e,i=0){this.timers.has(t)&&b(this.timers.get(t)),this.timers.set(t,y(e,i))}cancel(...t){0!=t.length?t.forEach((t=>{b(this.timers.get(t)),this.timers.delete(t)})):(this.timers.forEach(((t,e)=>b(t))),this.timers.clear())}}var _=Object.freeze({__proto__:null,sleep:E,delay:y,cancel:b,Timers:k});var x=Object.freeze({__proto__:null,begin:function(t){const e=`otree.${t}.beg`;performance.clearMarks(e),performance.mark(e)},end:function(t){const e=`otree.${t}.end`;performance.clearMarks(e),performance.mark(e);const i=`otree.${t}.beg`,s=`otree.${t}.measure`;return performance.clearMeasures(s),performance.measure(s,i,e),performance.getEntriesByName(s)[0].duration}});const I=new Map;function C(t,e){I.set(t,e)}class T{get name(){return"foo"}param(t){return void 0===t&&(t=this.name),this.elem.dataset["ot"+t[0].toUpperCase()+t.slice(1).toLowerCase()]}constructor(t,e){this.page=t,this.elem=e,this.handlers=new Map,this.init()}onEvent(t,e,i){this.page.onEvent(t,(t=>e.bind(this)(t,t.detail)),i)}init(){this.ref=this.param(),e(this.ref)}setup(){this.onEvent("ot.reset",this.onReset),this.onEvent("ot.update",this.onUpdate)}onReset(t,e){e.some((t=>i(t,this.ref)))&&this.reset(e)}reset(){throw new Error("Method not implemented")}onUpdate(t,e){e.affects(this.ref)&&this.update(e)}update(t){throw new Error("Method not implemented")}}C("[data-ot-ready]",class extends T{get name(){return"ready"}init(){const t=this.elem.dataset;this.trigger={click:"otClick"in t,touch:"otTouch"in t,key:"otKey"in t&&t.otKey},this.disabled=!1}setup(){this.trigger.key&&this.onEvent("keydown",this.onKey),this.trigger.touch&&this.onEvent("touchend",this.onClick,this.elem),this.trigger.click&&this.onEvent("click",this.onClick,this.elem),this.onEvent("ot.ready",this.onStart)}onKey(t){this.disabled||t.code==this.trigger.key&&(t.preventDefault(),this.page.emitEvent("ot.ready"))}onClick(t){this.disabled||(t.preventDefault(),this.page.emitEvent("ot.ready"))}onStart(){l(this.elem,!1),c(this.elem,!0)}});C("[data-ot-display]",class extends T{get name(){return"display"}init(){let t=this.param();if(!t.match(/^\w+(\|\w+)?$/))throw new Error(`Invalid display phase: ${this.phase}`);this.phases=t.split("|")}setup(){this.onEvent("ot.phase",this.onPhase)}onPhase(t,e){"display"in e&&l(this.elem,this.phases.includes(e.display))}});C("input[data-ot-input], select[data-ot-input], textarea[data-ot-input]",class extends T{get name(){return"input"}init(){this.ref=this.param(),e(this.ref)}setup(){this.onEvent("ot.phase",this.onPhase),this.onEvent("change",this.onChange,this.elem),f(this.elem)&&this.onEvent("keydown",this.onKey,this.elem)}onPhase(t,e){c(this.elem,!e.input)}onChange(t){let e=this.elem.value;"true"===e&&(e=!0),"false"===e&&(e=!1),this.page.emitInput({[this.ref]:e})}onKey(t){"Enter"==t.code&&setTimeout((()=>this.elem.dispatchEvent(new Event("change",{view:window,bubbles:!1,cancelable:!0}))))}});C("div[data-ot-input], span[data-ot-input], button[data-ot-input], kbd[data-ot-input]",class extends T{get name(){return"input"}init(){const t=this.param(),i=t.match(/^([\w.]+)(=(.+))$/);if(!i)throw new Error(`Invalid expression for input: ${t}`);this.ref=i[1],e(this.ref),this.val=i[3],"true"===this.val&&(this.val=!0),"false"===this.val&&(this.val=!1);const s=this.elem.dataset;this.trigger={click:"otClick"in s,touch:"otTouch"in s,key:"otKey"in s&&s.otKey},"BUTTON"==this.elem.tagName&&(this.trigger.click=!0)}setup(){this.onEvent("ot.phase",this.onPhase),this.trigger.key&&this.onEvent("keydown",this.onKey),this.trigger.touch&&this.onEvent("touchend",this.onClick,this.elem),this.trigger.click&&this.onEvent("click",this.onClick,this.elem)}onPhase(t,e){"input"in e&&c(this.elem,!e.input)}onClick(t){p(this.elem)||(t.preventDefault(),this.page.emitInput({[this.ref]:this.val}))}onKey(t){p(this.elem)||t.code==this.trigger.key&&(t.preventDefault(),this.page.emitInput({[this.ref]:this.val}))}});C("[data-ot-class]",class extends T{get name(){return"class"}init(){super.init(),this.defaults=Array.from(this.elem.classList)}reset(){u(this.elem,this.defaults)}update(t){let e=this.defaults.slice(),i=t.pick(this.ref);i&&e.push(i),u(this.elem,e)}});C("[data-ot-text]",class extends T{get name(){return"text"}reset(){d(this.elem,null)}update(t){d(this.elem,t.pick(this.ref))}});C("[data-ot-img]",class extends T{get name(){return"img"}reset(){g(this.elem,null)}update(t){let e=t.pick(this.ref);if(e&&!(e instanceof Image))throw new Error(`Invalid value for image: ${e}`);g(this.elem,e)}});class $ extends T{reset(){m(this.elem,this.name,null)}update(t){m(this.elem,this.name,t.pick(this.ref))}}["disabled","hidden","height","width","min","max","low","high","optimum","value"].forEach((t=>{C(`[data-ot-${t}]`,class extends ${get name(){return t}})}));C("[data-ot-when]",class extends T{get name(){return"when"}init(){const t=this.param(),i=t.match(/^([\w.]+)((===?)(.+))?$/);if(!i)throw new Error(`Invalid expression for when: ${t}`);const[s,n,a,r,o]=i;e(n),this.ref=n;let h=o?JSON.parse(o.replaceAll("'",'"')):null;this.check="=="==r?t=>void 0!==t&&t==h:"==="==r?t=>void 0!==t&&t===h:t=>void 0!==t}reset(){l(this.elem,!1)}update(t){let e=t.pick(this.ref),i=this.check(e);l(this.elem,i)}});class P{constructor(t){this.body=t||document.body,this.phase={},this.init()}init(){let t=this;I.forEach(((e,i)=>{this.body.querySelectorAll(i).forEach((i=>{new e(t,i).setup()}))})),this.resetPhase()}onEvent(t,e,i){(i||this.body).addEventListener(t,e)}offEvent(t,e,i){(i||this.body).removeEventListener(t,e)}waitEvent(t,e){return e=e||this.body,new Promise((i=>{e.addEventListener(t,(function s(n){i(n),e.removeEventListener(t,s)}))}))}emitEvent(t,e,i){const s=new CustomEvent(t,{detail:e});i=i||this.body,setTimeout((()=>i.dispatchEvent(s)))}emitReset(t){this.emitEvent("ot.reset",t||["game"])}emitInput(t){this.emitEvent("ot.input",t)}emitUpdate(t){t instanceof o||(t=new o(t)),this.emitEvent("ot.update",t)}emitTimeout(){this.emitEvent("ot.timeout")}freezeInputs(){this.emitEvent("ot.phase",{input:!1,_freezing:!0})}unfreezeInputs(){this.phase.input&&this.emitEvent("ot.phase",{input:!0,_freezing:!0})}switchDisplay(t){this.emitEvent("ot.phase",{display:t,_switching:!0})}resetPhase(t){let e={display:null,input:!1};t&&Object.assign(e,t),this.phase=e,this.emitEvent("ot.phase",{_resetting:!0,...e})}togglePhase(t){Object.assign(this.phase,t),this.emitEvent("ot.phase",t)}}class U{constructor(t){this.page=t,this.config={},this.state={},this.status={},this.error=void 0,this.result=void 0,this.iteration=void 0}setup(t){this.config=t,this.page.emitUpdate({config:t})}reset(){this.state={},this.status={},this.error=void 0,this.result=void 0,this.page.emitReset(["game","status","error","result"])}updateState(t){new o(t).patch(this.state),this.page.emitUpdate(new o(t,"game"))}setStatus(t){this.status=t,this.page.emitEvent("ot.status",t),this.page.emitUpdate({status:t})}setError(t,e){this.error={code:t,message:e},this.page.emitEvent("ot.error",this.error),this.page.emitUpdate({error:this.error})}clearError(){this.error=void 0,this.page.emitEvent("ot.error",null),this.page.emitReset("error")}start(){this.page.emitEvent("ot.started")}complete(t){this.result=t,this.page.emitEvent("ot.completed",t),this.page.emitUpdate({result:t})}async play(){return this.reset(),this.start(),(await this.page.waitEvent("ot.completed")).detail}async playIterations(t,e){let i;const s={total:t,current:0,completed:0,solved:0,failed:0},n=t?e=>e&&e<=t:t=>t;for(this.iteration=1;n(this.iteration);this.iteration++)s.current=this.iteration,this.page.emitUpdate({progress:s}),i=await this.play(),s.completed+=1,s.solved+=!0===i.success,s.failed+=!1===i.success,this.page.emitUpdate({progress:s}),await E(e);return s}stopIterations(){delete this.iteration}set onStart(t){this.page.onEvent("ot.started",(e=>t(e.detail)))}set onStatus(t){this.page.onEvent("ot.status",(e=>t(e.detail)))}set onError(t){this.page.onEvent("ot.error",(e=>t(e.detail)))}set onComplete(t){this.page.onEvent("ot.completed",(e=>t(e.detail)))}set onTimeout(t){this.page.onEvent("ot.timeout",(e=>t(e.detail)))}set onInput(t){this.page.onEvent("ot.input",(e=>t(e.detail)))}set onPhase(t){this.page.onEvent("ot.phase",(e=>{e.detail._resetting||e.detail._freezing||e.detail._switching||t(e.detail)}))}}class z{constructor(t){this.page=t,this.timers=new k,this.phases=null,this.timeout=null}setup(t){this.phases=t.phases,this.timeout=t.timeout}start(){this.phases&&this.phases.forEach(((t,e)=>{const i=Object.assign({},t);delete i.time,this.timers.delay(`phase-${e}`,(()=>{this.page.togglePhase(i)}),t.time)})),this.timeout&&this.timers.delay("timeout",(()=>{this.stop(),this.page.emitTimeout()}),this.timeout)}stop(){this.timers.cancel()}}const L={dom:v,random:w,changes:h,timers:_,measurement:x,Directive:T,registerDirective:C};window.addEventListener("load",(function(){if(window.page=new P(document.body),window.game=new U(window.page),window.schedule=new z(window.page),!window.main)throw new Error("You need to define global `function main()` to make otree work");window.main()})),window.otree=L;export{L as otree};
