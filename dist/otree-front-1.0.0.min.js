function t(t,e){return t==e||e.startsWith(t+".")}function e(t,e){if(t==e)return"";if(e.startsWith(t+"."))return e.slice(t.length+1);throw new Error(`Incompatible refs: ${t} / ${e}`)}function i(t,e){return e.split(".").reduce(((t,e)=>t&&e in t?t[e]:void 0),t)}function s(t,e,i){const s=e.split("."),n=s.slice(0,-1),r=s[s.length-1];let a=n.reduce(((t,e)=>e in t?t[e]:function(t,e){return t[e]={}}(t,e)),t);if(void 0===a)throw new Error(`Incompatible ref ${e}`);void 0===i?delete a[r]:a[r]=i}var n=Object.freeze({__proto__:null,includes:t,strip:e,extract:i,update:s});const r=new RegExp(/^[a-zA-Z]\w+(\.\w+)*$/);function a(t){let e=r.exec(t);if(!e)throw new Error(`Invalid expression for var: "${t}"`);return{ref:e[0]}}function o(t,e){const{ref:i}=t;return e.pick(i)}const h=new RegExp(/^([\w.]+)( ([!=]=) (.+))?$/);function l(t){let e=h.exec(t);if(!e)throw new Error(`Invalid condition expression: "${t}"`);if(!r.exec(e[1]))throw new Error(`Invalid variable in condition expression: "${t}"`);let[i,s,n,a,o]=e;if(o)try{o=JSON.parse(o.replaceAll("'",'"'))}catch{throw new Error(`Invalid value in condition expression: ${t}`)}else o=void 0;return{ref:s,eq:a,val:o}}function c(t,e){const{ref:i,eq:s,val:n}=t;let r=e.pick(i);return void 0===s?!!r:"=="==s?r===n:"!="==s?r!==n:void 0}const u=new RegExp(/^([\w.]+) = (.+)?$/);function d(e,i){switch(i.type){case"ot.reset":let s=i.detail;return null==s||s.some((i=>t(i,e.ref)));case"ot.update":return i.detail.affects(e.ref);default:return!1}}class m extends Map{constructor(t,e){let i=[...Object.entries(t)];e&&(i=i.map((([t,i])=>[e+"."+t,i]))),super(i),this.forEach(((t,e)=>a(e)))}affects(e){return[...this.keys()].some((i=>t(i,e)))}pick(s){let n=[...this.keys()].filter((e=>t(e,s)));if(0==n.length)return;if(1!=n.length)throw new Error(`Incompatible changeset for ${s}`);n=n[0];let r=this.get(n);return n==s?r:i(r,e(n,s))}patch(t){this.forEach(((e,i)=>{s(t,i,e)}))}}var p=Object.freeze({__proto__:null,Ref:n,Changes:m});function g(t){const e=new Image;return new Promise(((i,s)=>{e.onload=()=>i(e),e.onerror=s,e.src=t}))}function v(t,e){t.style.display=e?null:"none"}function f(t,e){t.disabled=e,t.classList.toggle("ot-disabled",e)}function E(t){return t.classList.contains("ot-disabled")}function w(t,e){t.innerText=null==e?"":e}function b(t,e){t.classList.remove(...t.classList),t.classList.add(...e)}function y(t,e,i){null==i?t.removeAttribute(e):t.setAttribute(e,i)}function k(t,e){null==e?t.replaceChildren():t.replaceChildren(e)}function x(t){return"INPUT"==t.tagName&&"text"==t.type||"TEXTAREA"==t.tagName}var _=Object.freeze({__proto__:null,loadImage:g,toggleDisplay:v,toggleDisabled:f,isDisabled:E,setText:w,setClasses:b,setAttr:y,setChild:k,isTextInput:x});var T=Object.freeze({__proto__:null,choice:function(t){return t[Math.floor(Math.random()*t.length)]}});async function $(t){return new Promise(((e,i)=>{setTimeout((()=>e()),t)}))}function P(t,e=0){return window.setTimeout(t,e)}function I(t){window.clearTimeout(t)}class z{constructor(){this.timers=new Map}delay(t,e,i=0){this.timers.has(t)&&I(this.timers.get(t)),this.timers.set(t,P(e,i))}cancel(...t){0!=t.length?t.forEach((t=>{I(this.timers.get(t)),this.timers.delete(t)})):(this.timers.forEach(((t,e)=>I(t))),this.timers.clear())}}var R=Object.freeze({__proto__:null,sleep:$,delay:P,cancel:I,Timers:z});async function C(t,e){for(let[i,s]of Object.entries(e)){if("image"!==s)throw new Error("Unsupported media type to preload");try{t[i]=await g(t[i])}catch{throw new Error(`Failed to load media ${t[i]}`)}}}var O=Object.freeze({__proto__:null,preloadMedia:C});var U=Object.freeze({__proto__:null,begin:function(t){const e=`otree.${t}.beg`;performance.clearMarks(e),performance.mark(e)},end:function(t){const e=`otree.${t}.end`;performance.clearMarks(e),performance.mark(e);const i=`otree.${t}.beg`,s=`otree.${t}.measure`;return performance.clearMeasures(s),performance.measure(s,i,e),performance.getEntriesByName(s)[0].duration}});const A=new Map;function j(t,e){A.set(t,e)}class F{getParam(t){return this.elem.getAttribute(`ot-${t}`)}hasParam(t){return this.elem.hasAttribute(`ot-${t}`)}constructor(t,e){this.page=t,this.elem=e,this.init()}init(){}onEvent(t,e){this.page.onEvent(t,e.bind(this))}onElemEvent(t,e){this.page.onElemEvent(this.elem,t,e.bind(this))}setup(){this.onReset&&this.onEvent("ot.reset",this.onReset),this.onUpdate&&this.onEvent("ot.update",this.onUpdate)}}class L extends F{init(){this.hasParam("enabled")?(this.cond=l(this.getParam("enabled")),this.enabled=!1):(this.cond=null,this.enabled=!0)}onReset(t,e){this.cond?d(this.cond,t)&&(this.enabled=!1):this.enabled=!0,f(this.elem,!this.enabled)}onUpdate(t,e){this.cond&&d(this.cond,t)&&(this.enabled=c(this.cond,e),f(this.elem,!this.enabled))}onFreezing(t,e){f(this.elem,!this.enabled||e)}}function D(t){return{click:t.hasParam("click")||"BUTTON"==t.elem.tagName,touch:t.hasParam("touch"),key:!!t.hasParam("key")&&t.getParam("key")}}j("[ot-input]:is(input, select, textarea)",class extends L{init(){super.init(),this.var=a(this.getParam("input"))}setup(){this.onEvent("ot.reset",this.onReset),this.onEvent("ot.update",this.onUpdate),this.onEvent("ot.freezing",this.onFreezing),x(this.elem)?this.onElemEvent("keydown",this.onKey):this.onElemEvent("change",this.onChange)}onReset(t,e){super.onReset(t,e),d(this.var,t)&&(this.elem.value=null)}onUpdate(t,e){super.onUpdate(t,e),d(this.var,t)&&(this.elem.value=o(this.var,e))}onChange(t){this.submit()}onKey(t){"Enter"==t.code&&this.submit()}submit(){this.page.emitEvent("ot.input",{name:this.var.ref,value:this.elem.value})}});j("[ot-input]:not(input, select, textarea)",class extends L{init(){super.init(),this.ass=function(t){let e=u.exec(t);if(!e)throw new Error(`Invalid input expression: "${t}"`);if(!r.exec(e[1]))throw new Error(`Invalid variable in input expression: "${t}"`);let[i,s,n]=e;try{n=JSON.parse(e[2].replaceAll("'",'"'))}catch{throw new Error(`Invalid value in assignment expression: ${t}`)}return{ref:s,val:n}}(this.getParam("input")),this.trigger=D(this)}setup(){this.onEvent("ot.reset",this.onReset),this.onEvent("ot.update",this.onUpdate),this.onEvent("ot.freezing",this.onFreezing),this.trigger.key&&this.onEvent("keydown",this.onKey),this.trigger.touch&&this.onElemEvent("touchend",this.onClick),this.trigger.click&&this.onElemEvent("click",this.onClick)}onClick(t){E(this.elem)||(t.preventDefault(),this.submit())}onKey(t){E(this.elem)||t.code==this.trigger.key&&(t.preventDefault(),this.submit())}submit(){this.page.emitEvent("ot.input",{name:this.ass.ref,value:this.ass.val})}});j("[ot-emit]",class extends L{init(){super.init(),this.evtype=this.getParam("emit"),this.trigger=D(this)}setup(){this.onEvent("ot.reset",this.onReset),this.onEvent("ot.update",this.onUpdate),this.onEvent("ot.freezing",this.onFreezing),this.trigger.key&&this.onEvent("keydown",this.onKey),this.trigger.touch&&this.onElemEvent("touchend",this.onClick),this.trigger.click&&this.onElemEvent("click",this.onClick)}onClick(t){E(this.elem)||(t.preventDefault(),this.submit())}onKey(t){E(this.elem)||t.code==this.trigger.key&&(t.preventDefault(),this.submit())}submit(){this.page.emitEvent(this.evtype)}});j("[ot-class]",class extends F{init(){this.var=a(this.getParam("class")),this.defaults=Array.from(this.elem.classList)}onReset(t,e){d(this.var,t)&&b(this.elem,this.defaults)}onUpdate(t,e){if(d(this.var,t)){let t=this.defaults.slice(),i=o(this.var,e);i&&t.push(i),b(this.elem,t)}}});j("[ot-text]",class extends F{init(){this.var=a(this.getParam("text"))}onReset(t,e){d(this.var,t)&&w(this.elem,null)}onUpdate(t,e){d(this.var,t)&&w(this.elem,o(this.var,e))}});j("[ot-img]",class extends F{init(){this.var=a(this.getParam("img"))}onReset(t,e){d(this.var,t)&&k(this.elem,null)}onUpdate(t,e){if(d(this.var,t)){let t=o(this.var,e);if(t&&!(t instanceof Image))throw new Error(`Invalid value for image: ${t}`);k(this.elem,t)}}});class M extends F{get name(){throw new Error("name getter should be defined")}init(){this.var=a(this.getParam(this.name))}onReset(t,e){d(this.var,t)&&y(this.elem,this.name,null)}onUpdate(t,e){d(this.var,t)&&y(this.elem,this.name,o(this.var,e))}}["height","width","min","max","low","high","optimum","value"].forEach((t=>{j(`[ot-${t}]`,class extends M{get name(){return t}})}));j("[ot-if]",class extends F{init(){this.cond=l(this.getParam("if"))}onReset(t){d(this.cond,t)&&v(this.elem,!1)}onUpdate(t,e){d(this.cond,t)&&v(this.elem,c(this.cond,e))}});class N{constructor(t){this.body=t||document.body,this.init()}init(){let t=this;A.forEach(((e,i)=>{this.body.querySelectorAll(i).forEach((i=>{new e(t,i).setup()}))})),this.reset()}onEvent(t,e){this.body.addEventListener(t,(t=>e(t,t.detail)))}onElemEvent(t,e,i){t.addEventListener(e,(t=>i(t,t.detail)))}waitForEvent(t){let e=this.body;return new Promise((i=>{e.addEventListener(t,(function s(n){i(n),e.removeEventListener(t,s)}))}))}emitEvent(t,e){setTimeout((()=>this.body.dispatchEvent(new CustomEvent(t,{detail:e}))))}emitElemEvent(t,e,i){setTimeout((()=>t.dispatchEvent(new CustomEvent(e,{detail:i}))))}reset(t){void 0===t||Array.isArray(t)||(t=[t]),this.emitEvent("ot.reset",t)}update(t){t instanceof m||(t=new m(t)),this.emitEvent("ot.update",t)}timeout(t){this.emitEvent("ot.timeout",t)}freezeInputs(){this.emitEvent("ot.freezing",!0)}unfreezeInputs(){this.emitEvent("ot.freezing",!1)}submitInputs(t){this.body.querySelectorAll(`[ot-input="${t}"]`).forEach((e=>{this.emitEvent("ot.input",{name:t,value:e.value})}))}submit(){this.body.querySelector("form").submit()}set onInput(t){this.onEvent("ot.input",(e=>t(e.detail.name,e.detail.value)))}set onUpdate(t){this.onEvent("ot.update",(e=>t(e.detail)))}set onTimeout(t){this.onEvent("ot.timeout",(e=>t(e.detail)))}}class S{constructor(t){this.page=t,this.config={},this.trial={},this.status={},this.feedback=void 0}setConfig(t){this.config=t,this.page.update({config:t})}resetTrial(){this.trial={},this.status={},this.feedback=void 0,this.page.reset(["trial","status","feedback"]),this.loadTrial()}async setTrial(t){this.trial=t,this.config.media_fields&&await C(t,this.config.media_fields),this.page.update({trial:t}),await this.page.waitForEvent("ot.update"),this.startTrial(this.trial)}updateTrial(t){new m(t).patch(this.trial),this.page.update(new m(t,"trial"))}updateStatus(t){let e=this.status;Object.assign(e,t),this.page.update({status:t}),this.page.emitEvent("ot.status",t),t.trialStarted&&this.page.emitEvent("ot.started"),t.trialCompleted&&this.page.emitEvent("ot.completed"),t.gameOver&&this.page.emitEvent("ot.gameover")}setFeedback(t){this.feedback=t,this.page.update({feedback:t}),this.onFeedback(this.feedback)}clearFeedback(){this.feedback=void 0,this.page.reset("feedback")}setProgress(t){this.progress=t,this.page.update({progress:t}),this.onProgress(this.progress)}resetProgress(){this.progress=void 0,this.page.reset("progress")}loadTrial(){throw new Error("Implement the `loadTrial` hook")}startTrial(t){throw new Error("Implement the `startTrial` hook")}onFeedback(t){}onProgress(t){}set onStatus(t){this.page.onEvent("ot.status",(e=>t(this.status,e.detail)))}async playTrial(){this.resetTrial(),await this.page.waitForEvent("ot.completed")}async playIterations(){for(;!this.status.gameOver;)await this.playTrial(),await $(this.config.post_trial_pause)}}class K{constructor(t){this.page=t,this.timers=new z,this.phases=[],this.timeout=null}setup(t){this.phases=t}at(t,e){this.phases.push({at:t,...e})}setTimeout(t){this.timeout=t}start(){this.phases&&this.phases.forEach(((t,e)=>{let i=Object.assign({},t);delete i.at,this.timers.delay(`phase-${e}`,(()=>{this.page.update(i)}),t.at)})),this.timeout&&this.timers.delay("timeout",(()=>{this.stop(),this.page.timeout(this.timeout)}),this.timeout)}stop(){this.timers.cancel()}}void 0===window.otree&&(window.otree={}),window.addEventListener("load",(function(){if(window.otree.page=new N(document.body),window.otree.game=new S(otree.page),window.otree.schedule=new K(otree.page),!window.main)throw new Error("You need to define global `function main()` to make otree work");window.main()})),Object.assign(window.otree,{utils:{dom:_,random:T,timers:R,measurement:U,changes:p,trials:O},directives:{DirectiveBase:F,registerDirective:j}});
