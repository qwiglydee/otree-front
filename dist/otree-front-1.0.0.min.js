const t=new RegExp(/^[a-zA-Z]\w+(\.\w+)*$/);function e(e){if(!e||!t.exec(e))throw new Error(`Invalid ref: ${e}`)}function i(t,e){return t==e||e.startsWith(t+".")}function s(t,e){if(t==e)return"";if(e.startsWith(t+"."))return e.slice(t.length+1);throw new Error(`Incompatible refs: ${t} / ${e}`)}function n(t,e){return e.split(".").reduce(((t,e)=>t&&e in t?t[e]:void 0),t)}function a(t,e,i){const s=e.split("."),n=s.slice(0,-1),a=s[s.length-1];let r=n.reduce(((t,e)=>e in t?t[e]:function(t,e){return t[e]={}}(t,e)),t);if(void 0===r)throw new Error(`Incompatible ref ${e}`);void 0===i?delete r[a]:r[a]=i}var r=Object.freeze({__proto__:null,validate:e,includes:i,strip:s,extract:n,update:a});class o extends Map{constructor(t,i){let s=[...Object.entries(t)];i&&(s=s.map((([t,e])=>[i+"."+t,e]))),super(s),this.forEach(((t,i)=>e(i)))}affects(t){return[...this.keys()].some((e=>i(e,t)))}pick(t){let e=[...this.keys()].filter((e=>i(e,t)));if(0==e.length)return;if(1!=e.length)throw new Error(`Incompatible changeset for ${t}`);e=e[0];let a=this.get(e);return e==t?a:n(a,s(e,t))}patch(t){this.forEach(((e,i)=>{a(t,i,e)}))}}var h=Object.freeze({__proto__:null,Ref:r,Changes:o});function l(t){const e=new Image;return new Promise(((i,s)=>{e.onload=()=>i(e),e.onerror=s,e.src=t}))}function u(t,e){t.style.display=e?null:"none"}function c(t,e){t.disabled=e,t.classList.toggle("ot-disabled",e)}function p(t){return t.classList.contains("ot-disabled")}function m(t,e){t.innerText=null==e?"":e}function d(t,e){t.classList.remove(...t.classList),t.classList.add(...e)}function g(t,e,i){null==i?t.removeAttribute(e):t.setAttribute(e,i)}function f(t,e){null==e?t.replaceChildren():t.replaceChildren(e)}function v(t){return"INPUT"==t.tagName&&"text"==t.type||"TEXTAREA"==t.tagName}var E=Object.freeze({__proto__:null,loadImage:l,toggleDisplay:u,toggleDisabled:c,isDisabled:p,setText:m,setClasses:d,setAttr:g,setChild:f,isTextInput:v});var w=Object.freeze({__proto__:null,choice:function(t){return t[Math.floor(Math.random()*t.length)]}});async function b(t){return new Promise(((e,i)=>{setTimeout((()=>e()),t)}))}function y(t,e=0){return window.setTimeout(t,e)}function k(t){window.clearTimeout(t)}class _{constructor(){this.timers=new Map}delay(t,e,i=0){this.timers.has(t)&&k(this.timers.get(t)),this.timers.set(t,y(e,i))}cancel(...t){0!=t.length?t.forEach((t=>{k(this.timers.get(t)),this.timers.delete(t)})):(this.timers.forEach(((t,e)=>k(t))),this.timers.clear())}}var T=Object.freeze({__proto__:null,sleep:b,delay:y,cancel:k,Timers:_});var x=Object.freeze({__proto__:null,begin:function(t){const e=`otree.${t}.beg`;performance.clearMarks(e),performance.mark(e)},end:function(t){const e=`otree.${t}.end`;performance.clearMarks(e),performance.mark(e);const i=`otree.${t}.beg`,s=`otree.${t}.measure`;return performance.clearMeasures(s),performance.measure(s,i,e),performance.getEntriesByName(s)[0].duration}});const A=new Map;function I(t,e){A.set(t,e)}class P{get name(){return"foo"}param(t){return void 0===t&&(t=this.name),this.elem.getAttribute(`ot-${t}`)}constructor(t,e){this.page=t,this.elem=e,this.handlers=new Map,this.init()}onEvent(t,e,i){this.page.onEvent(t,(t=>e.bind(this)(t,t.detail)),i)}init(){this.ref=this.param(),e(this.ref)}setup(){this.onEvent("ot.reset",this.onReset),this.onEvent("ot.update",this.onUpdate)}onReset(t,e){("*"==e||e.some((t=>i(t,this.ref))))&&this.reset(e)}reset(){throw new Error("Method not implemented")}onUpdate(t,e){e.affects(this.ref)&&this.update(e)}update(t){throw new Error("Method not implemented")}}I("[ot-ready]",class extends P{get name(){return"ready"}init(){this.trigger={click:this.elem.hasAttribute("ot-click"),touch:this.elem.hasAttribute("ot-touch"),key:!!this.elem.hasAttribute("ot-key")&&this.elem.getAttribute("ot-key")},this.disabled=!1}setup(){this.trigger.key&&this.onEvent("keydown",this.onKey),this.trigger.touch&&this.onEvent("touchend",this.onClick,this.elem),this.trigger.click&&this.onEvent("click",this.onClick,this.elem),this.onEvent("ot.ready",this.onStart)}onKey(t){this.disabled||t.code==this.trigger.key&&(t.preventDefault(),this.page.emitEvent("ot.ready"))}onClick(t){this.disabled||(t.preventDefault(),this.page.emitEvent("ot.ready"))}onStart(){u(this.elem,!1),c(this.elem,!0)}});I("[ot-display]",class extends P{get name(){return"display"}init(){let t=this.param();if(!t.match(/^\w+(\|\w+)?$/))throw new Error(`Invalid display phase: ${this.phase}`);this.phases=t.split("|")}setup(){this.onEvent("ot.phase",this.onPhase)}onPhase(t,e){"display"in e&&u(this.elem,this.phases.includes(e.display))}});I("input[ot-input], select[ot-input], textarea[ot-input]",class extends P{get name(){return"input"}init(){}setup(){this.onEvent("ot.reset",this.onReset),this.onEvent("ot.phase",this.onPhase),this.onEvent("change",this.onChange,this.elem),v(this.elem)&&this.onEvent("keydown",this.onKey,this.elem)}onReset(t,e){this.elem.value=null}onPhase(t,e){c(this.elem,!e.inputEnabled)}onChange(t){let e=this.elem.value;"true"===e&&(e=!0),"false"===e&&(e=!1),this.page.emitInput(this.elem.name,e)}onKey(t){"Enter"==t.code&&setTimeout((()=>this.elem.dispatchEvent(new Event("change",{view:window,bubbles:!1,cancelable:!0}))))}});I("div[ot-input], span[ot-input], button[ot-input], kbd[ot-input]",class extends P{get name(){return"input"}init(){if(this.inp_name=this.elem.getAttribute("name"),this.inp_value=this.elem.getAttribute("value"),void 0===this.inp_value)throw new Error("Missing value attribute for ot-input");"true"===this.inp_value&&(this.inp_value=!0),"false"===this.inp_value&&(this.inp_value=!1),this.trigger={click:this.elem.hasAttribute("ot-click"),touch:this.elem.hasAttribute("ot-touch"),key:!!this.elem.hasAttribute("ot-key")&&this.elem.getAttribute("ot-key")},"BUTTON"==this.elem.tagName&&(this.trigger.click=!0)}setup(){this.onEvent("ot.phase",this.onPhase),this.trigger.key&&this.onEvent("keydown",this.onKey),this.trigger.touch&&this.onEvent("touchend",this.onClick,this.elem),this.trigger.click&&this.onEvent("click",this.onClick,this.elem)}onPhase(t,e){"inputEnabled"in e&&c(this.elem,!e.inputEnabled)}onClick(t){p(this.elem)||(t.preventDefault(),this.page.emitInput(this.inp_name,this.inp_value))}onKey(t){p(this.elem)||t.code==this.trigger.key&&(t.preventDefault(),this.page.emitInput(this.inp_name,this.inp_value))}});I("[ot-class]",class extends P{get name(){return"class"}init(){super.init(),this.defaults=Array.from(this.elem.classList)}reset(){d(this.elem,this.defaults)}update(t){let e=this.defaults.slice(),i=t.pick(this.ref);i&&e.push(i),d(this.elem,e)}});I("[ot-text]",class extends P{get name(){return"text"}reset(){m(this.elem,null)}update(t){m(this.elem,t.pick(this.ref))}});I("[ot-img]",class extends P{get name(){return"img"}reset(){f(this.elem,null)}update(t){let e=t.pick(this.ref);if(e&&!(e instanceof Image))throw new Error(`Invalid value for image: ${e}`);f(this.elem,e)}});class $ extends P{reset(){g(this.elem,this.name,null)}update(t){g(this.elem,this.name,t.pick(this.ref))}}["disabled","hidden","height","width","min","max","low","high","optimum","value"].forEach((t=>{I(`[ot-${t}]`,class extends ${get name(){return t}})}));I("[ot-when]",class extends P{get name(){return"when"}init(){const t=this.param(),i=t.match(/^([\w.]+)((===?)(.+))?$/);if(!i)throw new Error(`Invalid expression for when: ${t}`);const[s,n,a,r,o]=i;e(n),this.ref=n;let h=o?JSON.parse(o.replaceAll("'",'"')):null;this.check="=="==r?t=>void 0!==t&&t==h:"==="==r?t=>void 0!==t&&t===h:t=>void 0!==t}reset(){u(this.elem,!1)}update(t){let e=t.pick(this.ref),i=this.check(e);u(this.elem,i)}});class C{constructor(t){this.body=t||document.body,this.phase={},this.init()}init(){let t=this;A.forEach(((e,i)=>{this.body.querySelectorAll(i).forEach((i=>{new e(t,i).setup()}))})),this.resetPhase(),this.emitReset()}onEvent(t,e,i){(i||this.body).addEventListener(t,e)}offEvent(t,e,i){(i||this.body).removeEventListener(t,e)}waitForEvent(t,e){return e=e||this.body,new Promise((i=>{e.addEventListener(t,(function s(n){i(n),e.removeEventListener(t,s)}))}))}emitEvent(t,e,i){const s=new CustomEvent(t,{detail:e});i=i||this.body,setTimeout((()=>i.dispatchEvent(s)))}emitReset(t){void 0===t?this.emitEvent("ot.reset","*"):(Array.isArray(t)||(t=[t]),this.emitEvent("ot.reset",t))}emitInput(t,e){this.emitEvent("ot.input",{name:t,value:e})}emitUpdate(t){t instanceof o||(t=new o(t)),this.emitEvent("ot.update",t)}emitTimeout(t){this.emitEvent("ot.timeout",t)}freezeInputs(){this.emitEvent("ot.phase",{inputEnabled:!1,_freezing:!0})}unfreezeInputs(){this.phase.inputEnabled&&this.emitEvent("ot.phase",{inputEnabled:!0,_freezing:!0})}switchDisplay(t){this.emitEvent("ot.phase",{display:t,_switching:!0})}resetPhase(t){let e={display:null,inputEnabled:!1};t&&Object.assign(e,t),this.phase=e,this.emitEvent("ot.phase",{_resetting:!0,...e})}togglePhase(t){Object.assign(this.phase,t),this.emitEvent("ot.phase",t)}submit(){this.documentQuery("form").submit()}set onReady(t){this.onEvent("ot.ready",(e=>t()))}set onInput(t){this.onEvent("ot.input",(e=>t(e.detail.name,e.detail.value)))}set onUpdate(t){this.onEvent("ot.update",(e=>t(e.detail)))}set onPhase(t){this.onEvent("ot.phase",(e=>{e.detail._resetting||e.detail._freezing||e.detail._switching||t(e.detail)}))}set onTimeout(t){this.onEvent("ot.timeout",(e=>t(e.detail)))}}class O{constructor(t){this.page=t,this.config={},this.trial={},this.status={},this.feedback=void 0}setConfig(t){this.config=t,this.page.emitUpdate({config:t})}resetTrial(){this.trial={},this.status={},this.feedback=void 0,this.page.emitReset(["trial","status","feedback"]),this.loadTrial()}async setTrial(t){if(this.trial=t,this.config.preload_media)for(let t in this.config.preload_media){if("img"!==this.config.preload_media[t])throw new Error("Unsupported media type to preload");this.trial[t]=await l(this.trial[t])}this.page.emitUpdate({trial:t}),await this.page.waitForEvent("ot.update"),this.startTrial(this.trial)}updateTrial(t){new o(t).patch(this.trial),this.page.emitUpdate(new o(t,"trial"))}updateStatus(t){let e=this.status;Object.assign(e,t),this.page.emitUpdate({status:t}),this.page.emitEvent("ot.status",t),t.trialStarted&&this.page.emitEvent("ot.started"),t.trialCompleted&&this.page.emitEvent("ot.completed"),t.gameOver&&this.page.emitEvent("ot.gameover")}setFeedback(t){this.feedback=t,this.page.emitUpdate({feedback:t}),this.onFeedback(this.feedback)}clearFeedback(){this.feedback=void 0,this.page.emitReset("feedback")}setProgress(t){this.progress=t,this.page.emitUpdate({progress:t}),this.onProgress(this.progress)}resetProgress(){this.progress=void 0,this.page.emitReset("progress")}loadTrial(){throw new Error("Implement the `loadTrial` hook")}startTrial(t){throw new Error("Implement the `startTrial` hook")}onFeedback(t){}onProgress(t){}set onStatus(t){this.page.onEvent("ot.status",(e=>t(this.status,e.detail)))}async playTrial(){this.resetTrial(),await this.page.waitForEvent("ot.completed")}async playIterations(){for(;!this.status.gameOver;)await this.playTrial(),await b(this.config.post_trial_pause)}}class R{constructor(t){this.page=t,this.timers=new _,this.phases=null,this.timeout=null}setup(t){this.phases=t.phases,this.timeout=t.timeout}start(){this.phases&&this.phases.forEach(((t,e)=>{const i=Object.assign({},t);delete i.at,this.timers.delay(`phase-${e}`,(()=>{this.page.togglePhase(i)}),t.at)})),this.timeout&&this.timers.delay("timeout",(()=>{this.stop(),this.page.emitTimeout(this.timeout)}),this.timeout)}stop(){this.timers.cancel()}}const U={dom:E,random:w,changes:h,timers:T,measurement:x,DirectiveBase:P,registerDirective:I};window.addEventListener("load",(function(){if(U.page=new C(document.body),U.game=new O(U.page),U.schedule=new R(U.page),!window.main)throw new Error("You need to define global `function main()` to make otree work");window.main()})),window.otree=U;export{U as otree};
