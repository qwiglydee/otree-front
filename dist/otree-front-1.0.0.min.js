const t=new RegExp(/^[a-zA-Z]\w+(\.\w+)*$/);function e(e){let i=t.exec(e);if(!i)throw new Error(`Invalid expression for var: "${e}"`);return{ref:i[0]}}function i(t,e){const{ref:i}=t;return e.pick(i)}const s=new RegExp(/^([\w.]+)( ([!=]=) (.+))?$/);function n(e){let i=s.exec(e);if(!i)throw new Error(`Invalid condition expression: "${e}"`);if(!t.exec(i[1]))throw new Error(`Invalid variable in condition expression: "${e}"`);let[n,a,r,o,h]=i;if(h)try{h=JSON.parse(h.replaceAll("'",'"'))}catch{throw new Error(`Invalid value in condition expression: ${e}`)}else h=void 0;return{ref:a,eq:o,val:h}}function a(t,e){const{ref:i,eq:s,val:n}=t;let a=e.pick(i);return void 0===s?!!a:"=="==s?a===n:"!="==s?a!==n:void 0}const r=new RegExp(/^([\w.]+) = (.+)?$/);function o(t,e){switch(e.type){case"ot.reset":let i=e.detail;return null==i||i.includes(t.ref);case"ot.update":return e.detail.affects(t.ref);default:return!1}}function h(t,e){return t==e||e.startsWith(t+".")}function l(t,e){if(t==e)return"";if(e.startsWith(t+"."))return e.slice(t.length+1);throw new Error(`Incompatible refs: ${t} / ${e}`)}function c(t,e){return e.split(".").reduce(((t,e)=>t&&e in t?t[e]:void 0),t)}function d(t,e,i){const s=e.split("."),n=s.slice(0,-1),a=s[s.length-1];let r=n.reduce(((t,e)=>e in t?t[e]:function(t,e){return t[e]={}}(t,e)),t);if(void 0===r)throw new Error(`Incompatible ref ${e}`);void 0===i?delete r[a]:r[a]=i}var u=Object.freeze({__proto__:null,includes:h,strip:l,extract:c,update:d});class m extends Map{constructor(t,i){let s=[...Object.entries(t)];i&&(s=s.map((([t,e])=>[i+"."+t,e]))),super(s),this.forEach(((t,i)=>e(i)))}affects(t){return[...this.keys()].some((e=>h(e,t)))}pick(t){let e=[...this.keys()].filter((e=>h(e,t)));if(0==e.length)return;if(1!=e.length)throw new Error(`Incompatible changeset for ${t}`);e=e[0];let i=this.get(e);return e==t?i:c(i,l(e,t))}patch(t){this.forEach(((e,i)=>{d(t,i,e)}))}}var p=Object.freeze({__proto__:null,Ref:u,Changes:m});function g(t){const e=new Image;return new Promise(((i,s)=>{e.onload=()=>i(e),e.onerror=s,e.src=t}))}function f(t,e){t.style.display=e?null:"none"}function v(t,e){t.disabled=e,t.classList.toggle("ot-disabled",e)}function E(t){return t.classList.contains("ot-disabled")}function w(t,e){t.innerText=null==e?"":e}function b(t,e){t.classList.remove(...t.classList),t.classList.add(...e)}function y(t,e,i){null==i?t.removeAttribute(e):t.setAttribute(e,i)}function k(t,e){null==e?t.replaceChildren():t.replaceChildren(e)}function P(t){return"INPUT"==t.tagName&&"text"==t.type||"TEXTAREA"==t.tagName}var x=Object.freeze({__proto__:null,loadImage:g,toggleDisplay:f,toggleDisabled:v,isDisabled:E,setText:w,setClasses:b,setAttr:y,setChild:k,isTextInput:P});var T=Object.freeze({__proto__:null,choice:function(t){return t[Math.floor(Math.random()*t.length)]}});async function _(t){return new Promise(((e,i)=>{setTimeout((()=>e()),t)}))}function I(t,e=0){return window.setTimeout(t,e)}function U(t){window.clearTimeout(t)}class ${constructor(){this.timers=new Map}delay(t,e,i=0){this.timers.has(t)&&U(this.timers.get(t)),this.timers.set(t,I(e,i))}cancel(...t){0!=t.length?t.forEach((t=>{U(this.timers.get(t)),this.timers.delete(t)})):(this.timers.forEach(((t,e)=>U(t))),this.timers.clear())}}var R=Object.freeze({__proto__:null,sleep:_,delay:I,cancel:U,Timers:$});var z=Object.freeze({__proto__:null,begin:function(t){const e=`otree.${t}.beg`;performance.clearMarks(e),performance.mark(e)},end:function(t){const e=`otree.${t}.end`;performance.clearMarks(e),performance.mark(e);const i=`otree.${t}.beg`,s=`otree.${t}.measure`;return performance.clearMeasures(s),performance.measure(s,i,e),performance.getEntriesByName(s)[0].duration}});const C=new Map;function A(t,e){C.set(t,e)}class O{getParam(t){return this.elem.getAttribute(`ot-${t}`)}hasParam(t){return this.elem.hasAttribute(`ot-${t}`)}constructor(t,e){this.page=t,this.elem=e,this.init()}init(){}onPageEvent(t,e){let i=e.bind(this);this.page.onEvent(t,(t=>i(t,t.detail)))}onElemEvent(t,e){let i=e.bind(this);this.page.onEvent(t,(t=>i(t,t.detail)),this.elem)}setup(){this.onReset&&this.onPageEvent("ot.reset",this.onReset),this.onUpdate&&this.onPageEvent("ot.update",this.onUpdate)}}A("[ot-ready]",class extends O{init(){this.trigger={click:this.hasParam("click")||"BUTTON"==this.elem.tagName,touch:this.hasParam("touch"),key:!!this.hasParam("key")&&this.getParam("key")}}setup(){this.trigger.key&&this.onPageEvent("keydown",this.onKey),this.trigger.touch&&this.onElemEvent("touchend",this.onClick),this.trigger.click&&this.onElemEvent("click",this.onClick),this.onPageEvent("ot.ready",this.onStart)}onKey(t){this.disabled||t.code==this.trigger.key&&(t.preventDefault(),this.page.emitEvent("ot.ready"))}onClick(t){this.disabled||(t.preventDefault(),this.page.emitEvent("ot.ready"))}onStart(){f(this.elem,!1),v(this.elem,!0)}});class L extends O{init(){this.hasParam("enabled")?(this.cond=n(this.getParam("enabled")),this.enabled=!1):(this.cond=null,this.enabled=!0)}onReset(t,e){this.cond?o(this.cond,t)&&(this.enabled=!1):this.enabled=!0,v(this.elem,!this.enabled)}onUpdate(t,e){this.cond&&o(this.cond,t)&&(this.enabled=a(this.cond,e),v(this.elem,!this.enabled))}onFreezing(t,e){v(this.elem,!this.enabled||e)}}A("[ot-input]:is(input, select, textarea)",class extends L{init(){super.init(),this.var=e(this.getParam("input"))}setup(){this.onPageEvent("ot.reset",this.onReset),this.onPageEvent("ot.update",this.onUpdate),this.onPageEvent("ot.freezing",this.onFreezing),P(this.elem)?this.onElemEvent("keydown",this.onKey):this.onElemEvent("change",this.onChange)}onReset(t,e){super.onReset(t,e),o(this.var,t)&&(this.elem.value=null)}onUpdate(t,e){super.onUpdate(t,e),o(this.var,t)&&(this.elem.value=i(this.var,e))}onChange(t){this.submit()}onKey(t){"Enter"==t.code&&this.submit()}submit(){this.page.emitInput(this.var.ref,this.elem.value)}});A("[ot-input]:not(input, select, textarea)",class extends L{init(){super.init(),this.ass=function(e){let i=r.exec(e);if(!i)throw new Error(`Invalid input expression: "${e}"`);if(!t.exec(i[1]))throw new Error(`Invalid variable in input expression: "${e}"`);let[s,n,a]=i;try{a=JSON.parse(i[2].replaceAll("'",'"'))}catch{throw new Error(`Invalid value in assignment expression: ${e}`)}return{ref:n,val:a}}(this.getParam("input")),this.trigger={click:this.hasParam("click")||"BUTTON"==this.elem.tagName,touch:this.hasParam("touch"),key:!!this.hasParam("key")&&this.getParam("key")}}setup(){this.onPageEvent("ot.reset",this.onReset),this.onPageEvent("ot.update",this.onUpdate),this.onPageEvent("ot.freezing",this.onFreezing),this.trigger.key&&this.onPageEvent("keydown",this.onKey),this.trigger.touch&&this.onElemEvent("touchend",this.onClick),this.trigger.click&&this.onElemEvent("click",this.onClick)}onClick(t){E(this.elem)||(t.preventDefault(),this.page.emitInput(this.ass.ref,this.ass.val))}onKey(t){E(this.elem)||t.code==this.trigger.key&&(t.preventDefault(),this.page.emitInput(this.ass.ref,this.ass.val))}});A("[ot-class]",class extends O{init(){this.var=e(this.getParam("class")),this.defaults=Array.from(this.elem.classList)}onReset(t,e){o(this.var,t)&&b(this.elem,this.defaults)}onUpdate(t,e){if(o(this.var,t)){let t=this.defaults.slice(),s=i(this.var,e);s&&t.push(s),b(this.elem,t)}}});A("[ot-text]",class extends O{init(){this.var=e(this.getParam("text"))}onReset(t,e){o(this.var,t)&&w(this.elem,null)}onUpdate(t,e){o(this.var,t)&&w(this.elem,i(this.var,e))}});A("[ot-img]",class extends O{init(){this.var=e(this.getParam("img"))}onReset(t,e){o(this.var,t)&&k(this.elem,null)}onUpdate(t,e){if(o(this.var,t)){let t=i(this.var,e);if(t&&!(t instanceof Image))throw new Error(`Invalid value for image: ${t}`);k(this.elem,t)}}});class F extends O{get name(){throw new Error("name getter should be defined")}init(){this.var=e(this.getParam(this.name))}onReset(t,e){o(this.var,t)&&y(this.elem,this.name,null)}onUpdate(t,e){o(this.var,t)&&y(this.elem,this.name,i(this.var,e))}}["height","width","min","max","low","high","optimum","value"].forEach((t=>{A(`[ot-${t}]`,class extends F{get name(){return t}})}));A("[ot-if]",class extends O{init(){this.cond=n(this.getParam("if"))}onReset(t){o(this.cond,t)&&f(this.elem,!1)}onUpdate(t,e){o(this.cond,t)&&f(this.elem,a(this.cond,e))}});class N{constructor(t){this.body=t||document.body,this.init()}init(){let t=this;C.forEach(((e,i)=>{this.body.querySelectorAll(i).forEach((i=>{new e(t,i).setup()}))})),this.emitReset()}onEvent(t,e,i){(i||this.body).addEventListener(t,e)}offEvent(t,e,i){(i||this.body).removeEventListener(t,e)}waitForEvent(t,e){return e=e||this.body,new Promise((i=>{e.addEventListener(t,(function s(n){i(n),e.removeEventListener(t,s)}))}))}emitEvent(t,e,i){const s=new CustomEvent(t,{detail:e});i=i||this.body,setTimeout((()=>i.dispatchEvent(s)))}emitReset(t){void 0===t||Array.isArray(t)||(t=[t]),this.emitEvent("ot.reset",t)}emitInput(t,e){this.emitEvent("ot.input",{name:t,value:e})}emitUpdate(t){t instanceof m||(t=new m(t)),this.emitEvent("ot.update",t)}emitTimeout(t){this.emitEvent("ot.timeout",t)}freezeInputs(){this.emitEvent("ot.freezing",!0)}unfreezeInputs(){this.emitEvent("ot.freezing",!1)}submitInputs(t){this.body.querySelectorAll(`[ot-input="${t}"]`).forEach((e=>{this.emitInput(t,e.value)}))}submit(){this.body.querySelector("form").submit()}set onReady(t){this.onEvent("ot.ready",(e=>t()))}set onInput(t){this.onEvent("ot.input",(e=>t(e.detail.name,e.detail.value)))}set onUpdate(t){this.onEvent("ot.update",(e=>t(e.detail)))}set onTimeout(t){this.onEvent("ot.timeout",(e=>t(e.detail)))}}class S{constructor(t){this.page=t,this.config={},this.trial={},this.status={},this.feedback=void 0}setConfig(t){this.config=t,this.page.emitUpdate({config:t})}resetTrial(){this.trial={},this.status={},this.feedback=void 0,this.page.emitReset(["trial","status","feedback"]),this.loadTrial()}async setTrial(t){if(this.trial=t,this.config.preload_media)for(let t in this.config.preload_media){if("img"!==this.config.preload_media[t])throw new Error("Unsupported media type to preload");this.trial[t]=await g(this.trial[t])}this.page.emitUpdate({trial:t}),await this.page.waitForEvent("ot.update"),this.startTrial(this.trial)}updateTrial(t){new m(t).patch(this.trial),this.page.emitUpdate(new m(t,"trial"))}updateStatus(t){let e=this.status;Object.assign(e,t),this.page.emitUpdate({status:t}),this.page.emitEvent("ot.status",t),t.trialStarted&&this.page.emitEvent("ot.started"),t.trialCompleted&&this.page.emitEvent("ot.completed"),t.gameOver&&this.page.emitEvent("ot.gameover")}setFeedback(t){this.feedback=t,this.page.emitUpdate({feedback:t}),this.onFeedback(this.feedback)}clearFeedback(){this.feedback=void 0,this.page.emitReset("feedback")}setProgress(t){this.progress=t,this.page.emitUpdate({progress:t}),this.onProgress(this.progress)}resetProgress(){this.progress=void 0,this.page.emitReset("progress")}loadTrial(){throw new Error("Implement the `loadTrial` hook")}startTrial(t){throw new Error("Implement the `startTrial` hook")}onFeedback(t){}onProgress(t){}set onStatus(t){this.page.onEvent("ot.status",(e=>t(this.status,e.detail)))}async playTrial(){this.resetTrial(),await this.page.waitForEvent("ot.completed")}async playIterations(){for(;!this.status.gameOver;)await this.playTrial(),await _(this.config.post_trial_pause)}}class j{constructor(t){this.page=t,this.timers=new $,this.phases=[],this.timeout=null}setup(t){this.phases=t}at(t,e){this.phases.push({at:t,...e})}setTimeout(t){this.timeout=t}start(){this.phases&&this.phases.forEach(((t,e)=>{let i=Object.assign({},t);delete i.at,this.timers.delay(`phase-${e}`,(()=>{this.page.emitUpdate(i)}),t.at)})),this.timeout&&this.timers.delay("timeout",(()=>{this.stop(),this.page.emitTimeout(this.timeout)}),this.timeout)}stop(){this.timers.cancel()}}const D={dom:x,random:T,changes:p,timers:R,measurement:z,DirectiveBase:O,registerDirective:A};window.addEventListener("load",(function(){if(D.page=new N(document.body),D.game=new S(D.page),D.schedule=new j(D.page),!window.main)throw new Error("You need to define global `function main()` to make otree work");window.main()})),window.otree=D;export{D as otree};
