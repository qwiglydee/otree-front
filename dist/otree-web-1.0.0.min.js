const e=new RegExp(/^[a-zA-Z]\w+(\.\w+)*$/);function t(t){if(!t||!e.exec(t))throw new Error(`Invalid ref: ${t}`)}function i(e,t){return e==t||t.startsWith(e+".")}function s(e,t){if(e==t)return"";if(t.startsWith(e+"."))return t.slice(e.length+1);throw new Error(`Incompatible refs: ${e} / ${t}`)}function r(e,t){return t.split(".").reduce(((e,t)=>e&&t in e?e[t]:void 0),e)}function n(e,t,i){const s=t.split("."),r=s.slice(0,-1),n=s[s.length-1];let a=r.reduce(((e,t)=>t in e?e[t]:function(e,t){return e[t]={}}(e,t)),e);if(void 0===a)throw new Error(`Incompatible ref ${t}`);void 0===i?delete a[n]:a[n]=i}var a=Object.freeze({__proto__:null,validate:t,includes:i,strip:s,extract:r,update:n});class o extends Map{constructor(e,i){let s=[...Object.entries(e)];i&&(s=s.map((([e,t])=>[i+"."+e,t]))),super(s),this.forEach(((e,i)=>t(i)))}affects(e){return[...this.keys()].some((t=>i(t,e)))}pick(e){let t=[...this.keys()].filter((t=>i(t,e)));if(0==t.length)return;if(1!=t.length)throw new Error(`Incompatible changeset for ${e}`);t=t[0];let n=this.get(t);return t==e?n:r(n,s(t,e))}patch(e){this.forEach(((t,i)=>{n(e,i,t)}))}}var h=Object.freeze({__proto__:null,Ref:a,Changes:o});const l=new Map;function c(e,t){l.set(e,t)}class p{get name(){return"foo"}param(e){return void 0===e&&(e=this.name),this.elem.dataset["ot"+e[0].toUpperCase()+e.slice(1).toLowerCase()]}constructor(e,t){this.page=e,this.elem=t,this.handlers=new Map,this.init()}on(e,t,i){return void 0!==i&&i!==this.page||(i=this.page.body),this.page.on(e,t.bind(this),i)}init(){this.ref=this.param(this.name),t(this.ref)}setup(){this.on("otree.page.update",this.onUpdate)}onUpdate(e,t){t.affects(this.ref)&&this.update(t)}update(e){throw new Error("Method not implemented")}}var u=Object.freeze({__proto__:null,registry:l,registerDirective:c,Directive:p});class d{constructor(e){this.body=e||document.body,this.init()}init(){let e=this;l.forEach(((t,i)=>{this.body.querySelectorAll(i).forEach((i=>{new t(e,i).setup()}))}))}on(e,t,i){i=i||this.body;const s=e=>t(e,e.detail);return s.off=()=>i.removeEventListener(e,s),i.addEventListener(e,s),s}wait(e,t){return t=t||this.body,new Promise((i=>{t.addEventListener(e,(function s(r){i(r),t.removeEventListener(e,s)}))}))}fire(e,t,i){const s=new CustomEvent(e,{detail:t});i=i||this.body,setTimeout((()=>i.dispatchEvent(s)))}reset(e="game"){this.fire("otree.page.reset",e),this.fire("otree.page.update",new o({[e]:void 0}))}start(){this.fire("otree.page.start")}update(e){e instanceof o||(e=new o(e)),this.fire("otree.page.update",e)}response(e){this.fire("otree.page.response",e)}toggle(e){this.fire("otree.time.phase",e)}timeout(){this.fire("otree.time.out")}}async function m(e){return new Promise(((t,i)=>{setTimeout((()=>t()),e)}))}function g(e,t=0){return window.setTimeout(e,t)}function f(e){window.clearTimeout(e)}class w{constructor(){this.timers=new Map}delay(e,t,i=0){this.timers.has(e)&&f(this.timers.get(e)),this.timers.set(e,g(t,i))}cancel(...e){0!=e.length?e.forEach((e=>{f(this.timers.get(e)),this.timers.delete(e)})):(this.timers.forEach(((e,t)=>f(e))),this.timers.clear())}}var v=Object.freeze({__proto__:null,sleep:m,delay:g,cancel:f,Timers:w});class y{constructor(e){this.page=e,this.conf={},this.state={}}reset(e){this.conf=e,this.page.update({conf:e}),this.state={},this.page.reset("game")}update(e){new o(e).patch(this.state),this.page.update(new o(e,"game"))}start(e){this.page.fire("otree.game.start",e)}status(e){this.page.fire("otree.game.status",e)}stop(e){this.page.fire("otree.game.stop",e)}error(e,t){let i={code:e,message:t};e||(i=null),this.page.fire("otree.game.error",i),this.page.update({error:i})}freeze(){this.page.fire("otree.time.phase",{input:!1})}unfreeze(){this.page.fire("otree.time.phase",{input:!0})}}async function b(e,t){return e.reset(t),e.start(),(await e.page.wait("otree.game.stop")).detail}async function k(e,t,i,s){let r={};const n={total:i,current:0,completed:0,solved:0,failed:0},a=i?e=>e<=i&&!r.terminate:e=>!r.terminate;for(let i=1;a(i);i++)n.current=i,e.page.update({progress:n}),r=await b(e,{iteration:i,...t}),n.completed+=1,n.solved+=!0===r.success,n.failed+=!1===r.success,e.page.update({progress:n}),await m(s);return n}class E{constructor(e){this.page=e,this.init()}init(){window.liveRecv=this.recv.bind(this)}recv(e){const t=e.type;delete e.type,this.page.fire(`otree.live.${t}`,e)}send(e,t){const i=Object.assign({type:e},t);window.liveSend(i),this.page.fire(`otree.live.${e}`,t)}}class _{constructor(e,t){this.page=e,this._timers=new w,this.timed=null,this.named=null,this.default=null,this.current=null,this.init(t),this.setup(),this.reset()}init(e){let t=e.filter((e=>!("name"in e)&&!("time"in e)));if(t.length>1)throw new Error("Duplicated default phases");1==t.length&&(this.default=t[0]);let i=e.filter((e=>"name"in e)),s=new Set(i.map((e=>e.name)));if(i.length!=s.size)throw new Error("Duplicated named phases");if(this.named=new Map(i.map((e=>[e.name,e]))),this.timed=e.filter((e=>"time"in e)),e.filter((e=>"timeout"in e)).length>1)throw new Error("Multiple timeouts in phases");if(e.filter((e=>!0===e.input)).length>1)throw new Error("Multiple input phases not supported")}setup(){this.page.on("otree.time.phase",(e=>{e.detail.input&&performance.mark("input")})),this.page.on("otree.page.response",(()=>{performance.mark("response")}))}run(){performance.clearMeasures(),performance.clearMarks(),this.timed.forEach(((e,t)=>{this._timers.delay(`phase-${t}`,(()=>this.toggle(e)),e.time),"timeout"in e&&this._timers.delay("timeout",(()=>this.timeout()),e.time+e.timeout)}))}toggle(e){this.current=e,this.page.fire("otree.time.phase",e)}timeout(){this.current=null,this.page.fire("otree.time.out"),this.cancel()}switch(e){this.toggle(this.named.get(e))}reset(){this.default&&this.toggle(this.default)}cancel(){this._timers.cancel()}reaction_time(){performance.measure("reaction_time","input","response");let e=performance.getEntriesByName("reaction_time").slice(-1);if(0!=e.length)return e[0].duration}}function x(e,t){e.style.display=t?null:"none"}function C(e,t){e.disabled=t,e.classList.toggle("ot-disabled",t)}function $(e){return e.classList.contains("ot-disabled")}function T(e,t){e.innerText=null==t?"":t}function I(e,t){e.classList.remove(...e.classList),e.classList.add(...t)}function M(e,t,i){null==i?e.removeAttribute(t):e.setAttribute(t,i)}function D(e,t){null==t?e.replaceChildren():e.replaceChildren(t)}function L(e){return"INPUT"==e.tagName&&"text"==e.type||"TEXTAREA"==e.tagName}var z=Object.freeze({__proto__:null,loadImage:function(e){const t=new Image;return new Promise(((i,s)=>{t.onload=()=>i(t),t.onerror=s,t.src=e}))},toggleDisplay:x,toggleDisabled:C,isDisabled:$,setText:T,setClasses:I,setAttr:M,setChild:D,isTextInput:L});c("[data-ot-start]",class extends p{get name(){return"start"}init(){const e=this.elem.dataset;this.trigger={click:"otClick"in e,touch:"otTouch"in e,key:"otKey"in e&&e.otKey},this.disabled=!1}setup(){this.trigger.key&&this.on("keydown",this.onKey,this.page),this.trigger.touch&&this.on("touchend",this.onClick,this.elem),this.trigger.click&&this.on("click",this.onClick,this.elem),this.on("otree.page.start",this.onStart)}onKey(e){this.disabled||e.code==this.trigger.key&&(e.preventDefault(),this.page.start())}onClick(e){this.disabled||(e.preventDefault(),this.page.start())}onStart(){x(this.elem,!1),C(this.elem,!0)}});c("[data-ot-display]",class extends p{get name(){return"display"}init(){let e=this.param();if(!e.match(/^\w+(\|\w+)?$/))throw new Error(`Invalid display phase: ${this.phase}`);this.phases=e.split("|")}setup(){this.on("otree.time.phase",this.onPhase)}onPhase(e,t){"display"in t&&x(this.elem,this.phases.includes(t.display))}});c("input[data-ot-input], select[data-ot-input], textarea[data-ot-input]",class extends p{get name(){return"input"}init(){this.ref=this.param(),t(this.ref)}setup(){this.on("otree.time.phase",this.onPhase),this.on("change",this.onChange,this.elem),L(this.elem)&&this.on("keydown",this.onKey,this.elem)}onPhase(e,t){C(this.elem,!t.input)}onChange(e){let t=this.elem.value;"true"===t&&(t=!0),"false"===t&&(t=!1),this.page.response({[this.ref]:t})}onKey(e){"Enter"==e.code&&setTimeout((()=>this.elem.dispatchEvent(new Event("change",{view:window,bubbles:!1,cancelable:!0}))))}});c("div[data-ot-input], span[data-ot-input], button[data-ot-input], kbd[data-ot-input]",class extends p{get name(){return"input"}init(){const e=this.param(),i=e.match(/^([\w.]+)(=(.+))$/);if(!i)throw new Error(`Invalid expression for input: ${e}`);this.ref=i[1],t(this.ref),this.val=i[3],"true"===this.val&&(this.val=!0),"false"===this.val&&(this.val=!1);const s=this.elem.dataset;this.trigger={click:"otClick"in s,touch:"otTouch"in s,key:"otKey"in s&&s.otKey},"BUTTON"==this.elem.tagName&&(this.trigger.click=!0)}setup(){this.on("otree.time.phase",this.onPhase),this.trigger.key&&this.on("keydown",this.onKey,this.page),this.trigger.touch&&this.on("touchend",this.onClick,this.elem),this.trigger.click&&this.on("click",this.onClick,this.elem)}onPhase(e,t){"input"in t&&C(this.elem,!t.input)}onClick(e){$(this.elem)||(e.preventDefault(),this.page.response({[this.ref]:this.val}))}onKey(e){$(this.elem)||e.code==this.trigger.key&&(e.preventDefault(),this.page.response({[this.ref]:this.val}))}});c("[data-ot-class]",class extends p{get name(){return"class"}init(){super.init(),this.defaults=Array.from(this.elem.classList)}update(e){let t=this.defaults.slice(),i=e.pick(this.ref);i&&t.push(i),I(this.elem,t)}});c("[data-ot-text]",class extends p{get name(){return"text"}update(e){T(this.elem,e.pick(this.ref))}});c("[data-ot-img]",class extends p{get name(){return"img"}update(e){let t=e.pick(this.ref);if(t&&!(t instanceof Image))throw new Error(`Invalid value for image: ${t}`);console.debug("ot-img",this.elem,t),D(this.elem,t)}});class K extends p{update(e){M(this.elem,this.name,e.pick(this.ref))}}["disabled","hidden","height","width","min","max","low","high","optimum","value"].forEach((e=>{c(`[data-ot-${e}]`,class extends K{get name(){return e}})}));c("[data-ot-when]",class extends p{get name(){return"when"}init(){const e=this.param(),i=e.match(/^([\w.]+)(==(.+))?$/);if(!i)throw new Error(`Invalid expression for when: ${e}`);this.ref=i[1],t(this.ref),this.cond=i[3],"true"===this.cond&&(this.cond=!0),"false"===this.cond&&(this.cond=!1)}update(e){let t=e.pick(this.ref),i=void 0!==this.cond?t==this.cond:!!t;x(this.elem,i)}});const P={dom:z,random:Object.freeze({__proto__:null,random_choice:function(e){return e[Math.floor(Math.random()*e.length)]}}),changes:h,timers:v};export{y as Game,E as Live,d as Page,_ as Schedule,u as directives,k as iterateRounds,b as playRound,P as utils};
