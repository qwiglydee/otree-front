function e(e,t){e.style.display=t?null:"none"}function t(e,t){e.disabled=t,e.classList.toggle("ot-disabled",t)}function i(e){return e.classList.contains("ot-disabled")}function s(e,t){e.innerText=null==t?"":t}function n(e,t){e.classList.remove(...e.classList),e.classList.add(...t)}function r(e,t,i){null==i?e.removeAttribute(t):e.setAttribute(t,i)}function a(e,t){null==t?e.replaceChildren():e.replaceChildren(t)}function o(e){return"INPUT"==e.tagName&&"text"==e.type||"TEXTAREA"==e.tagName}var h=Object.freeze({__proto__:null,loadImage:function(e){const t=new Image;return new Promise(((i,s)=>{t.onload=()=>i(t),t.onerror=s,t.src=e}))},toggleDisplay:e,toggleDisabled:t,isDisabled:i,setText:s,setClasses:n,setAttr:r,setChild:a,isTextInput:o});const l=new RegExp(/^[a-zA-Z]\w+(\.\w+)*$/);function c(e){if(!e||!l.exec(e))throw new Error(`Invalid ref: ${e}`)}function u(e,t){return e==t||t.startsWith(e+".")}function p(e,t){if(e==t)return"";if(t.startsWith(e+"."))return t.slice(e.length+1);throw new Error(`Incompatible refs: ${e} / ${t}`)}function d(e,t){return t.split(".").reduce(((e,t)=>e&&t in e?e[t]:void 0),e)}function m(e,t,i){const s=t.split("."),n=s.slice(0,-1),r=s[s.length-1];let a=n.reduce(((e,t)=>t in e?e[t]:function(e,t){return e[t]={}}(e,t)),e);if(void 0===a)throw new Error(`Incompatible ref ${t}`);void 0===i?delete a[r]:a[r]=i}var g=Object.freeze({__proto__:null,validate:c,includes:u,strip:p,extract:d,update:m});class f extends Map{constructor(e,t){let i=[...Object.entries(e)];t&&(i=i.map((([e,i])=>[t+"."+e,i]))),super(i),this.forEach(((e,t)=>c(t)))}affects(e){return[...this.keys()].some((t=>u(t,e)))}pick(e){let t=[...this.keys()].filter((t=>u(t,e)));if(0==t.length)return;if(1!=t.length)throw new Error(`Incompatible changeset for ${e}`);t=t[0];let i=this.get(t);return t==e?i:d(i,p(t,e))}patch(e){this.forEach(((t,i)=>{m(e,i,t)}))}}var w=Object.freeze({__proto__:null,Ref:g,Changes:f});const v=new Map;function y(e,t){v.set(e,t)}class k{get name(){return"foo"}param(e){return void 0===e&&(e=this.name),this.elem.dataset["ot"+e[0].toUpperCase()+e.slice(1).toLowerCase()]}constructor(e,t){this.page=e,this.elem=t,this.handlers=new Map,this.init()}on(e,t,i){return void 0!==i&&i!==this.page||(i=this.page.body),this.page.on(e,t.bind(this),i)}init(){this.ref=this.param(this.name),c(this.ref)}setup(){this.on("otree.page.update",this.onUpdate)}onUpdate(e,t){t.affects(this.ref)&&this.update(t)}update(e){throw new Error("Method not implemented")}}y("[data-ot-start]",class extends k{get name(){return"start"}init(){const e=this.elem.dataset;this.trigger={click:"otClick"in e,touch:"otTouch"in e,key:"otKey"in e&&e.otKey},this.disabled=!1}setup(){this.trigger.key&&this.on("keydown",this.onKey,this.page),this.trigger.touch&&this.on("touchend",this.onClick,this.elem),this.trigger.click&&this.on("click",this.onClick,this.elem),this.on("otree.page.start",this.onStart)}onKey(e){this.disabled||e.code==this.trigger.key&&(e.preventDefault(),this.page.start())}onClick(e){this.disabled||(e.preventDefault(),this.page.start())}onStart(){e(this.elem,!1),this.disabled=!0}});y("[data-ot-display]",class extends k{get name(){return"display"}init(){let e=this.param();if(!e.match(/^\w+(\|\w+)?$/))throw new Error(`Invalid display phase: ${this.phase}`);this.phases=e.split("|")}setup(){this.on("otree.time.phase",this.onPhase)}onPhase(t,i){"display"in i&&e(this.elem,this.phases.includes(i.display))}});y("input[data-ot-input], select[data-ot-input], textarea[data-ot-input]",class extends k{get name(){return"input"}init(){this.ref=this.param(),c(this.ref)}setup(){this.on("otree.time.phase",this.onPhase),this.on("change",this.onChange,this.elem),o(this.elem)&&this.on("keydown",this.onKey,this.elem)}onPhase(e,i){t(this.elem,!i.input)}onChange(e){let t=this.elem.value;"true"===t&&(t=!0),"false"===t&&(t=!1),this.page.response({[this.ref]:t})}onKey(e){"Enter"==e.code&&setTimeout((()=>this.elem.dispatchEvent(new Event("change",{view:window,bubbles:!1,cancelable:!0}))))}});y("div[data-ot-input], span[data-ot-input], button[data-ot-input], kbd[data-ot-input]",class extends k{get name(){return"input"}init(){const e=this.param(),t=e.match(/^([\w.]+)(=(.+))$/);if(!t)throw new Error(`Invalid expression for input: ${e}`);this.ref=t[1],c(this.ref),this.val=t[3],"true"===this.val&&(this.val=!0),"false"===this.val&&(this.val=!1);const i=this.elem.dataset;this.trigger={click:"otClick"in i,touch:"otTouch"in i,key:"otKey"in i&&i.otKey},"BUTTON"==this.elem.tagName&&(this.trigger.click=!0)}setup(){this.on("otree.time.phase",this.onPhase),this.trigger.key&&this.on("keydown",this.onKey,this.page),this.trigger.touch&&this.on("touchend",this.onClick,this.elem),this.trigger.click&&this.on("click",this.onClick,this.elem)}onPhase(e,i){"input"in i&&t(this.elem,!i.input)}onClick(e){i(this.elem)||(e.preventDefault(),this.page.response({[this.ref]:this.val}))}onKey(e){i(this.elem)||e.code==this.trigger.key&&(e.preventDefault(),this.page.response({[this.ref]:this.val}))}});y("[data-ot-class]",class extends k{get name(){return"class"}init(){super.init(),this.defaults=Array.from(this.elem.classList)}update(e){let t=this.defaults.slice(),i=e.pick(this.ref);i&&t.push(i),n(this.elem,t)}});y("[data-ot-text]",class extends k{get name(){return"text"}update(e){s(this.elem,e.pick(this.ref))}});y("[data-ot-img]",class extends k{get name(){return"img"}update(e){let t=e.pick(this.ref);if(t&&!(t instanceof Image))throw new Error(`Invalid value for image: ${t}`);a(this.elem,t)}});class b extends k{update(e){r(this.elem,this.name,e.pick(this.ref))}}["disabled","hidden","height","width","min","max","low","high","optimum","value"].forEach((e=>{y(`[data-ot-${e}]`,class extends b{get name(){return e}})}));y("[data-ot-when]",class extends k{get name(){return"when"}init(){const e=this.param(),t=e.match(/^([\w.]+)(==(.+))?$/);if(!t)throw new Error(`Invalid expression for when: ${e}`);this.ref=t[1],c(this.ref),this.cond=t[3],"true"===this.cond&&(this.cond=!0),"false"===this.cond&&(this.cond=!1)}update(t){let i=t.pick(this.ref),s=void 0!==this.cond?i==this.cond:!!i;e(this.elem,s)}});class E{constructor(e){this.body=e||document.body,this.init()}init(){let e=this;v.forEach(((t,i)=>{this.body.querySelectorAll(i).forEach((i=>{new t(e,i).setup()}))}))}on(e,t,i){i=i||this.body;const s=e=>t(e,e.detail);return s.off=()=>i.removeEventListener(e,s),i.addEventListener(e,s),s}wait(e,t){return t=t||this.body,new Promise((i=>{t.addEventListener(e,(function s(n){i(n),t.removeEventListener(e,s)}))}))}fire(e,t,i){const s=new CustomEvent(e,{detail:t});i=i||this.body,setTimeout((()=>i.dispatchEvent(s)))}reset(e="game"){this.fire("otree.page.reset",e),this.fire("otree.page.update",new f({[e]:void 0}))}start(){this.fire("otree.page.start")}update(e){e instanceof f||(e=new f(e)),this.fire("otree.page.update",e)}response(e){this.fire("otree.page.response",e)}toggle(e){this.fire("otree.time.phase",e)}timeout(){this.fire("otree.time.out")}}async function _(e){return new Promise(((t,i)=>{setTimeout((()=>t()),e)}))}function x(e,t=0){return window.setTimeout(e,t)}function C(e){return window.clearTimeout(e),null}class ${constructor(){this.timers=new Map}delay(e,t,i=0){this.timers.has(e)&&C(this.timers.get(e)),this.timers.set(e,x(t,i))}cancel(...e){0!=e.length?e.forEach((e=>{C(this.timers.get(e)),this.timers.delete(e)})):(this.timers.forEach(((e,t)=>C(e))),this.timers.clear())}}var T=Object.freeze({__proto__:null,sleep:_,delay:x,cancel:C,Timers:$});class I{constructor(){this.state=null,this.promise=new Promise(((e,t)=>{this.reject=e=>{t(e),this.state=!1},this.resolve=t=>{e(t),this.state=!0}}))}}class P{constructor(e){this.page=e,this.state={}}reset(){this.state={},this.page.reset("game")}update(e){new f(e).patch(this.state),this.page.update(new f(e,"game"))}status(e){this.page.fire("otree.game.status",e),this.page.update(new f(e,"status")),e.completed&&this.running.resolve(e)}error(e,t){let i;e?(i={code:e},t&&(i.message=t)):i=null,this.status({error:i})}freeze(){this.page.fire("otree.time.phase",{input:!1})}unfreeze(){this.page.fire("otree.time.phase",{input:!0})}async playRound(e){return this.running=new I,this.reset(),this.page.fire("otree.game.start",e),this.running.promise.then((e=>(this.page.fire("otree.game.stop",e),e)))}updateProgress(e,t){e.completed+=1,e.solved+=!0===t.success,e.failed+=!1===t.success,e.skipped+=void 0===t.success}async iterateRounds(e,t,i){const s={total:t,current:0,completed:0,skipped:0,solved:0,failed:0};let n={},r={...e};const a=e=>(!t||e<=t)&&!n.terminate;for(let e=1;a(e);e++)r.iteration=e,s.current=e,this.status({progress:s}),n=await this.playRound(r),this.updateProgress(s,n),this.status({progress:s}),await _(i);return s}}class M{constructor(e){this.page=e,this.init()}init(){window.liveRecv=this.recv.bind(this)}recv(e){const t=e.type;delete e.type,this.page.fire(`otree.live.${t}`,e)}send(e,t){const i=Object.assign({type:e},t);window.liveSend(i),this.page.fire(`otree.live.${e}`,t)}}class L{constructor(e,t){this.page=e,this._timers=new $,this.timed=null,this.named=null,this.default=null,this.current=null,this.init(t),this.setup(),this.reset()}init(e){let t=e.filter((e=>!("name"in e)&&!("time"in e)));if(t.length>1)throw new Error("Duplicated default phases");1==t.length&&(this.default=t[0]);let i=e.filter((e=>"name"in e)),s=new Set(i.map((e=>e.name)));if(i.length!=s.size)throw new Error("Duplicated named phases");if(this.named=new Map(i.map((e=>[e.name,e]))),this.timed=e.filter((e=>"time"in e)),e.filter((e=>"timeout"in e)).length>1)throw new Error("Multiple timeouts in phases");if(e.filter((e=>!0===e.input)).length>1)throw new Error("Multiple input phases not supported")}setup(){this.page.on("otree.time.phase",(e=>{e.detail.input&&performance.mark("input")})),this.page.on("otree.page.response",(()=>{performance.mark("response"),performance.measure("reaction_time","input","response")}))}run(){performance.clearMeasures(),performance.clearMarks(),this.timed.forEach(((e,t)=>{this._timers.delay(`phase-${t}`,(()=>this.toggle(e)),e.time),"timeout"in e&&this._timers.delay("timeout",(()=>this.timeout()),e.time+e.timeout)}))}toggle(e){this.current=e,this.page.fire("otree.time.phase",e)}timeout(){this.current=null,this.page.fire("otree.time.out"),this.cancel()}switch(e){this.toggle(this.named.get(e))}reset(){this.default&&this.toggle(this.default)}cancel(){this._timers.cancel()}reaction_time(){let e=performance.getEntriesByName("reaction_time").slice(-1);if(0!=e.length)return e[0].duration}}const K={dom:h,random:Object.freeze({__proto__:null,random_choice:function(e){return e[Math.floor(Math.random()*e.length)]}}),changes:w,timers:T};export{k as Directive,P as Game,M as Live,E as Page,L as Schedule,y as registerDirective,K as utils};
